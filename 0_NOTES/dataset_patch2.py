# -*- coding: utf-8 -*-
"""dataset_patch2.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1_yMXDaHmD2deV4hKz5LCASaWpl7pe7Yf

# Dataset_Patch:

Single directory at a time...
"""

# Connect G_Drive
from google.colab import drive
drive.mount('/content/gdrive')

!ls /content/gdrive/MyDrive/2021_M_Eng/models/dataset/kaggle/

!ls "/content/gdrive/MyDrive/dataset/kaggle_new/" -l

# Get ONE directory at a time
# ~dirIn1 done~
#dirIn1 = "/content/gdrive/MyDrive/2021_M_Eng/models/dataset/kaggle/train/folding_marks/"
#dirIn2 = "/content/gdrive/MyDrive/2021_M_Eng/models/dataset/kaggle/train/grain_off/"
#dirIn3 = "/content/gdrive/MyDrive/2021_M_Eng/models/dataset/kaggle/train/growth_marks/"
#dirIn4 = "/content/gdrive/MyDrive/2021_M_Eng/models/dataset/kaggle/train/loose_grains/"
#dirIn5 = "/content/gdrive/MyDrive/2021_M_Eng/models/dataset/kaggle/train/non_defective/"
#dirIn6 = "/content/gdrive/MyDrive/2021_M_Eng/models/dataset/kaggle/train/pinhole/"

"""### Clear folder for next directory"""

!rm -r /content/leather/

!ls .

"""## Make new directory"""

# Create single dataset to then split
!mkdir /content/leather
!mkdir /content/leather/temp
!mkdir /content/leather/pinhole

# Get dataset dir2 from G_Drive
!cp -r /content/gdrive/MyDrive/2021_M_Eng/models/dataset/kaggle/train/pinhole/* /content/leather/pinhole/
!cp -r /content/gdrive/MyDrive/2021_M_Eng/models/dataset/kaggle/validate/pinhole/* /content/leather/pinhole/

print("complete")

"""## SPLIT IMAGES"""

from PIL import Image
from itertools import product
import os

# repeat for each of the 6 directories
#dir1 = "/content/leather/folding_marks"
#dir2 = "/content/leather/grain_off"
#dir3 = "/content/leather/growth_marks"
#dir4 = "/content/leather/loose_grains"
#dir5 = "/content/leather/non_defective"
dir6 = "/content/leather/pinhole"

# Check how many files in this directory (600 in each):
_, _, files = next(os.walk(dir6))
file_count = len(files)
print("File Count: {}".format(file_count))

# Split original image + Remane & store new patch images
def tile(filename, dir_in, dir_out, d):
    name, ext = os.path.splitext(filename)
    img = Image.open(os.path.join(dir_in, filename))
    w, h = img.size
    
    grid = product(range(0, h-h%d, d), range(0, w-w%d, d))
    for i, j in grid:
        box = (j, i, j+d, i+d)
        out = os.path.join(dir_out, f'{name}_{i}_{j}{ext}')

        img.crop(box).save(out)

"""### Split multiple images in given directory

On each iteration replace [dir1-dir6]
"""

# For each file in directory "dirX" "test" to "tiles":
d = 32
dir_out = dir6                          # images are stored in same directory
dir_in  = dir6                          # Repeat for each directory (dir1-dir6)

# List files in that directory
for filename in os.listdir(dir_in):
    f = os.path.join(dir_in, filename)
    # checking if it is a file
    if os.path.isfile(f):
        #print(f)                       # view each file created
        tile(f, dir_in, dir_out, d)     # split into blocks
        os.remove(f)                    # delete original

# Check Patches created (29,400)
_, _, files = next(os.walk(dir_in))
file_count = len(files)
print("File Count: {}".format(file_count))

"""## Before copying new dataset to dir2

### Clear failed folders
"""

# TEMPORARY: Clear 'dir2' - not enough patches
#!rm -r "/content/gdrive/MyDrive/dataset/kaggle_new/pinhole/"

!ls "/content/gdrive/MyDrive/dataset/kaggle_new/"

!ls "/content/gdrive/MyDrive/dataset/kaggle_new/non_defective/"

#!mkdir "/content/gdrive/MyDrive/dataset/kaggle_new/pinhole/"


# Check Patches created (29,400)
_, _, files = next(os.walk("/content/gdrive/MyDrive/dataset/kaggle_new/non_defective/"))
file_count = len(files)
print("File Count: {}".format(file_count))

!mkdir '/content/leather/temp2/'

"""## Split oversized directory into smaller batches

[44,039] = [29,400] + [14,639]
"""

# Move 14,639 files into separate 'temp' folder
import os
import shutil

source = r'/content/leather/pinhole/'  # files location
destination = r'/content/leather/temp/'     # where to move to 
folder = os.listdir(source)                 # returns a list with all the files in source

files = os.listdir(source)

# 'n' files
for f in range(14639): #files:
    shutil.move(source + files[f], destination)
    #print(source + files[f])

print("complete")

# Check Patches created (29,400)
_, _, files = next(os.walk(source))
file_count = len(files)
print("Source Count: {}".format(file_count))

destination = r'/content/leather/temp/'     # where to move to 

_, _, files = next(os.walk(destination))
file_count = len(files)
print("Temp1 Count: {}".format(file_count))

# When 44,039 pacthes created
"""
destination2 = r'/content/leather/temp2/'     # where to move to 

_, _, files = next(os.walk(destination2))
file_count = len(files)
print("Temp2 Count: {}".format(file_count))
"""

"""## Copy to G_Drive?"""

# Google Drive Destination Folders:
#dest1 = "/content/gdrive/MyDrive/dataset/kaggle_new/folding_marks/"
#dest2 = "/content/gdrive/MyDrive/dataset/kaggle_new/grain_off/"
#dest3 = "/content/gdrive/MyDrive/dataset/kaggle_new/growth_marks/"
#dest4 = "/content/gdrive/MyDrive/dataset/kaggle_new/loose_grains/"
#dest5 = "/content/gdrive/MyDrive/dataset/kaggle_new/non_defective/"
dest6 = "/content/gdrive/MyDrive/dataset/kaggle_new/pinhole/"

#import shutil

# METHOD 1: Single line copy method (max files <44000)
!cp /content/leather/pinhole/* /content/gdrive/MyDrive/dataset/kaggle_new/pinhole/

print("complete")

# Check Copy:

# Check Patches created (29,400)
_, _, files = next(os.walk(dest6))
file_count = len(files)
print("Source Count: {}".format(file_count))

"""## Save temp folder also"""

# Copy temp also
!mkdir "/content/gdrive/MyDrive/dataset/kaggle_new/pinhole_temp/"
!mkdir "/content/gdrive/MyDrive/dataset/kaggle_new/pinhole_temp2/"

!cp /content/leather/temp/* /content/gdrive/MyDrive/dataset/kaggle_new/pinhole_temp/
!cp /content/leather/temp2/* /content/gdrive/MyDrive/dataset/kaggle_new/pinhole_temp2/

"""## Shows on here but not in G_Drive??"""

# [LAST - pinhole]

show1 = '/content/gdrive/MyDrive/dataset/kaggle_new/pinhole_temp/'
show2 = '/content/gdrive/MyDrive/dataset/kaggle_new/pinhole_temp2/'

# Check Patches created (29,400)
_, _, files = next(os.walk(show1))
file_count = len(files)
print("File Count: {}".format(file_count))

# Check Patches created (29,400)
_, _, files = next(os.walk(show2))
file_count = len(files)
print("File Count: {}".format(file_count))

!ls '/content/gdrive/MyDrive/dataset/' -l | head -10

!ls '/content/gdrive/MyDrive/dataset/kaggle_temp/' -l | head -10
#!mv '/content/gdrive/MyDrive/dataset/kaggle_new/non_defective_temp' '/content/gdrive/MyDrive/dataset/kaggle_temp/'

#!ls '/content/gdrive/MyDrive/dataset/kaggle_temp/' -l

check = '/content/gdrive/MyDrive/dataset/kaggle_temp/'
# Check Patches created (29,400)
_, _, files = next(os.walk(check))
file_count = len(files)
print("File Count: {}".format(file_count))